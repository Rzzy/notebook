---
layout: post
title: TCP 基础
category: 网络
---

## 延迟与带宽

### 延迟的构成
- 传播时延：消息从发送端到接收端的时间
- 传输时延：消息中所有比特转移到链路中所需要的时间
- 处理时延：处理分组首部，检查位错误以及确定分组目标所需要的时间
- 排队延迟：到来的分组排队等待处理的时间

传播时延取决于发送端与接收端之间的距离以及传输媒介，传输时延与距离无关，它取决于传输链路的速率。当分组到达路由器的时候，路由器要对分组进行一些检查，这通常是用硬件完成的，很快但仍有延迟。如果分组到达速率超过了路由器的处理速率，那就存在排队时延。一路上经过的路由器越多每个分组的处理和传输时延就越多。

### 光速与传播时延

光速（30万公里/秒）,消息在铜线或者光纤中传播的速度达不到光速。光速与分组在介质中传输速度之比叫做介质的折射率，折射率越大，光在介质中传输的速度越慢。光纤的折射率约为 1.4~1.6 之间。

### 网络核心的带宽

光纤，通过波分复用技术，可以同时传输不同波长的光，带宽较大。一条光纤中可以耦合几百种不同波长的光，一条光纤的带宽可以达到几十 Tbit/s。
## TCP 的构成

### 三次握手

```
SYN x=rand() -->

<-- SYN ACK x+1 y=rand()

ACK y+1 x+1 -->
```
- SYN: 客户端选择一个随机序号 x,发送 SYN 分组
- SYN ACK: 服务器给 x 加 1 ，并选择自己的随机序列号 y ，然后返回响应
- ACK: 客户端给 x 和 y 加 1 ，并发送最后一次握手分组

以上便是三次握手的过程，在三次握手完成后就可以开始通信了，客户端可以在发送了 ACK 之后立刻开始发送数据，但是服务端需要在接收到 ACK 后才能发送数据。

每次 TCP 连接都要经过这样一次三次握手的过程。这也成为影响速率的地点。

### 拥塞预防及控制

#### 流量控制

通知接收窗口（rwnd）的大小来告知对方适合自己的传输速率

#### 慢启动

发送端和接收端在连接的初期都不知道自己的可用带宽，于是需要一种估算的机制，然后根据网络中变化的条件来实时地改变速率。如果客户端的带宽有限，而服务端发送数据过多，这会导致数据在某个中间网关越积越多，最终分组会被删除，降低网络传输效率。

解决这个问题的方法有:慢启动，拥塞预防，快速重发，快速恢复

在三次握手期间，连接双方通过 ACK 分组通告自己的接收窗口 (rwnd) 服务端和客户端都给自己一个初始的拥塞窗口 (cwnd) 变量，发送双方不会交换这个 cwnd ，客户端与服务端之间最大传输量为 rwnd 和 cwnd 中的较小值。（最初 cwnd 只有一个 TCP 段，1999年增加到了4个，2013年增加到了10个）

服务器向客户端发送 4 个 TCP 段，然后等待确认，没收到一个 ACK，慢启动算法就告诉服务器可以将其 cwnd 窗口增加一个 TCP 段，因此 cwnd 的大小在初始阶段会呈现指数型增长。

慢启动导致一些突发性的传输内容较少的连接性能不佳，因为往往连接还没有达到最大的传输速率的时候就以及传输完成了，这对于小文件的传输是很不利的。
